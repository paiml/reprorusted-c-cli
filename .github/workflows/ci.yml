name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Performance: keep CI under 2 minutes
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # TIER 1: Fast Validation (<10 seconds)
  # ============================================================================
  validate:
    name: Corpus Validation (206 tests)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Run corpus validation
      run: |
        chmod +x scripts/validate_corpus.sh
        ./scripts/validate_corpus.sh

    - name: Validation summary
      if: success()
      run: |
        echo "# Corpus Validation - SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: 206 passed" >> $GITHUB_STEP_SUMMARY
        echo "- **Examples**: 19 coreutils" >> $GITHUB_STEP_SUMMARY
        echo "- **Tiers**: P0 (8), P1 (6), P2 (5)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # TIER 2: Book Build (<30 seconds)
  # ============================================================================
  book:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: validate
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install mdBook
      run: |
        mkdir -p ~/.cargo/bin
        curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar -xz -C ~/.cargo/bin
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Build book
      run: |
        cd book && mdbook build

    - name: Upload book artifact
      uses: actions/upload-artifact@v4
      with:
        name: book
        path: book/output/

    - name: Book build summary
      if: success()
      run: |
        echo "# Book Build - SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Documentation built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Output: book/output/index.html" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # TIER 3: Linting (<2 minutes)
  # ============================================================================
  lint-scripts:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install shellcheck
      run: sudo apt-get install -y shellcheck

    - name: Run shellcheck
      run: |
        shellcheck scripts/*.sh

  lint-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate YAML files
      run: |
        echo "Validating YAML structure..."
        errors=0
        if [ -f corpus_metadata.yaml ]; then
          if ! grep -q "^version:" corpus_metadata.yaml; then
            echo "ERROR: Missing 'version:' in corpus_metadata.yaml"
            errors=1
          fi
        fi
        for yaml in examples/*/metadata.yaml; do
          if [ -f "$yaml" ]; then
            if ! grep -q "^name:" "$yaml"; then
              echo "ERROR: Missing 'name:' in $yaml"
              errors=1
            fi
          fi
        done
        if [ $errors -eq 0 ]; then
          echo "All YAML files valid"
        else
          exit 1
        fi

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check markdown links (book)
      run: |
        # Basic check: ensure all internal links in SUMMARY.md exist
        cd book/src
        while IFS= read -r line; do
          if [[ "$line" =~ \]\(([^)]+\.md)\) ]]; then
            file="${BASH_REMATCH[1]}"
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing file referenced in SUMMARY.md: $file"
              exit 1
            fi
          fi
        done < SUMMARY.md
        echo "All markdown links valid"

  # ============================================================================
  # TIER 4: Full CI Pipeline
  # ============================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [validate, book, lint-scripts, lint-yaml, lint-markdown]
    steps:
    - name: CI Summary
      run: |
        echo "# CI Pipeline - ALL CHECKS PASSED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Quality Gates" >> $GITHUB_STEP_SUMMARY
        echo "- Tier 1: Corpus Validation (206 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- Tier 2: Book Build" >> $GITHUB_STEP_SUMMARY
        echo "- Tier 3: Linting (shell, YAML, markdown)" >> $GITHUB_STEP_SUMMARY
        echo "- Tier 4: CI Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for CITL training!" >> $GITHUB_STEP_SUMMARY
